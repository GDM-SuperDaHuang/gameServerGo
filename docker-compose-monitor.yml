services:
  monitor1:
    image: alpine:latest
    container_name: docker-monitor
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - ldl_network
    command: >
      sh -c "
      apk add --no-cache docker-cli curl openssl coreutils jq &&
      SECRET='SECe5512edf3fc0ad0cf9d7e23ad67e88e7f695eba0298c7d370a13c82e640d68b6';
      TOKEN='3a82c9b9cd6eff02094f27497b847e8635abf2a740737a05b458e5f06b301062';

      docker events --filter 'event=die' |
      while read event; do
        # 获取容器名称
        CONTAINER=$(echo \$event | awk '{print \$4}');
      
        # 只处理 node-room-* / node-gate-*
        if echo \"\$CONTAINER\" | grep -Eq 'node-(room|gate)-[0-9]+'; then
      
          # 获取退出码
          CODE=$(docker inspect \$CONTAINER --format='{{.State.ExitCode}}');
      
          # 只报警非正常退出
          if [ \"\$CODE\" != \"0\" ]; then
            # 生成毫秒时间戳
            TIMESTAMP=$(date +%s%3N)
      
            # 构造签名字符串（真实换行）
            STRING_TO_SIGN=$(printf '%s\n%s' \$TIMESTAMP \$SECRET)
      
            # 计算 HmacSHA256 + Base64 + URL encode
            SIGN=$(printf '%s' \"\$STRING_TO_SIGN\" \
              | openssl dgst -sha256 -hmac \"\$SECRET\" -binary \
              | base64 \
              | tr -d '\n' \
              | jq -sRr @uri)
      
            # 拼接 webhook URL
            WEBHOOK_URL=\"https://oapi.dingtalk.com/robot/send?access_token=\$TOKEN&timestamp=\$TIMESTAMP&sign=\$SIGN\"

            # 发送报警
            curl -s \"\$WEBHOOK_URL\" \
              -H 'Content-Type: application/json' \
              -d '{\"msgtype\":\"text\",\"text\":{\"content\":\"【服务器异常】容器: '\$CONTAINER' 退出码: '\$CODE'\"}}'
          fi
        fi
      done
      "
networks:
  ldl_network:
    driver: bridge