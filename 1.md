monitor 容器监控退出

ExitCode	含义
0	        正常退出
1	        panic
137	        OOM
143	        docker stop


monitor:
image: alpine:latest
container_name: docker-monitor
restart: always
volumes:
- /var/run/docker.sock:/var/run/docker.sock
networks:
- ldl_network
command: >
sh -c "
apk add --no-cache docker-cli curl &&
docker events --filter 'event=die' |
while read event; do
CONTAINER=$(echo $$event | awk '{print $$4}');
if [ \"$$CONTAINER\" = \"node-room-1\" ] || [ \"$$CONTAINER\" = \"node-gate-1\" ]; then
CODE=$(docker inspect $$CONTAINER --format='{{.State.ExitCode}}');
curl -s 'https://oapi.dingtalk.com/robot/send?access_token=XXX&timestamp=XXX&sign=XXX' \
-H 'Content-Type: application/json' \
-d '{\"msgtype\":\"text\",\"text\":{\"content\":\"容器异常退出: '$$CONTAINER' 退出码: '$$CODE'\"}}';
fi
done
"

